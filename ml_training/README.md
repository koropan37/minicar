# 機械学習トレーニング用ディレクトリ

ジョイスティック操作データを使った機械学習のためのディレクトリです。

## 📁 ディレクトリ構成

```
ml_training/
├── data/
│   ├── raw/          # 生の録画データ（joystick_controlで収集したCSV）
│   └── processed/    # 前処理済みデータ（正規化、クリーニング済み）
├── models/           # 学習済みモデル（.pickle, .pth など）
├── scripts/          # 学習・評価スクリプト
├── notebooks/        # Jupyter Notebook（データ分析・可視化用）
├── config/           # 学習設定ファイル
└── README.md
```

## 🚀 使い方

### 1. データ収集
```bash
# joystick_controlでデータを収集
cd ../joystick_control
python main.py

# Aボタン: 録画開始
# Bボタン: 録画停止
# → data/record_data_YYYYMMDD_HHMMSS.csv に保存される
```

### 2. データを移動
```bash
# 収集したデータをrawディレクトリにコピー
cp ../joystick_control/data/*.csv data/raw/
```

### 3. 前処理
```bash
python scripts/preprocess.py
```

### 4. 学習
```bash
python scripts/train.py
```

### 5. 評価
```bash
python scripts/evaluate.py
```

### 6. 実車テスト
```bash
python scripts/drive.py
```

---

## ⚙️ モデル設定

### プリセット（簡単設定）

`config/settings.py` の `PRESET` を変更するだけで切り替え可能：

```python
PRESET = "medium"  # "small", "medium", "large", "custom" から選択
```

| プリセット | モデルタイプ | 隠れ層 | 予測対象 | 推奨データ量 |
|-----------|-------------|--------|----------|-------------|
| `small` | mlp_classifier（分類） | (32, 32) | steering | 300件〜 |
| `medium` | mlp_regressor（回帰） | (64, 64) | steering, throttle | 500件〜 |
| `large` | mlp_regressor（回帰） | (128, 128, 64) | steering, throttle | 3000件〜 |
| `custom` | 個別設定を使用 | 個別設定 | 個別設定 | - |

---

## 🤖 モデルタイプ詳細

### 1. mlp_regressor（多層パーセプトロン - 回帰）
```
センサー値 [L2, L1, C, R1, R2] → 連続値 [-1.0 〜 1.0]
```
- **特徴**: 滑らかなステアリング・スロットル制御
- **メリット**: 細かい制御が可能、自然な動き
- **デメリット**: データ量が必要（1000件以上推奨）
- **用途**: 本番走行、精密な制御

### 2. mlp_classifier（多層パーセプトロン - 分類）
```
センサー値 [L2, L1, C, R1, R2] → クラス [左/直進/右]
```
- **特徴**: 離散的なクラスを予測
- **メリット**: 少ないデータでも動作、シンプル
- **デメリット**: カクカクした動きになりやすい
- **用途**: テスト走行、データが少ない場合

### 3. random_forest（ランダムフォレスト）
```
センサー値 [L2, L1, C, R1, R2] → 予測値
```
- **特徴**: 決定木のアンサンブル学習
- **メリット**: 過学習しにくい、パラメータ調整が少ない
- **デメリット**: MLPより精度が劣る場合がある
- **用途**: 初回テスト、ベースライン比較

---

## 🧠 隠れ層（HIDDEN_LAYERS）について

ニューラルネットワークの構造を決定します。

```
入力層 → 隠れ層1 → 隠れ層2 → ... → 出力層
[5個]    [64個]    [64個]         [1-2個]
センサー                          steering/throttle
```

| 設定 | 構造 | 用途 |
|------|------|------|
| `(32,)` | 1層・32ニューロン | 最小構成、〜300件 |
| `(32, 32)` | 2層・各32ニューロン | 小規模、300〜500件 |
| `(64, 64)` | 2層・各64ニューロン | 標準、500〜1500件 |
| `(64, 64, 32)` | 3層 | 中規模、1500〜3000件 |
| `(128, 128, 64)` | 3層（大） | 大規模、3000件以上 |

### 調整のコツ
- **過学習（訓練精度は高いがテスト精度が低い）** → 層を減らす or ニューロン数を減らす
- **精度が足りない** → 層やニューロンを増やす or データを増やす

---

## 📊 データ形式

### 入力データ（CSV）
| カラム | 説明 | 範囲 |
|--------|------|------|
| timestamp | 経過時間（秒） | 0.0〜 |
| steering | ステアリング値 | -1.0〜1.0 |
| throttle | スロットル値 | -1.0〜1.0 |
| L2 | 左外センサー距離 | 0〜1000mm |
| L1 | 左内センサー距離 | 0〜1000mm |
| C | 正面センサー距離 | 0〜1000mm |
| R1 | 右内センサー距離 | 0〜1000mm |
| R2 | 右外センサー距離 | 0〜1000mm |

### 学習の流れ
```
[CSV生データ] → [前処理] → [正規化データ] → [学習] → [モデル.pickle]
data/raw/       preprocess.py   data/processed/   train.py   models/
```

---

## 🔧 必要なライブラリ

```bash
pip install numpy pandas scikit-learn matplotlib
```

---

## 📈 改善のヒント

1. **データの質を上げる**
   - 様々なコースで収集
   - 上手い操作のデータを多く集める
   - 異常値（壁に衝突時など）を除外

2. **データの量を増やす**
   - 最低300件、理想は1000件以上
   - 左右均等に曲がるデータを集める

3. **モデルを調整する**
   - まず `small` プリセットで試す
   - 精度を見ながら `medium` → `large` へ

4. **state_machine と組み合わせる**
   - 緊急停止・コーナー検出はルールベース
   - 通常走行は機械学習
