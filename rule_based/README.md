# ルールベース走行システム

左壁沿いに自動走行するミニカー制御プログラム。

## ディレクトリ構成

```
rule_based/
├── main.py              # メインプログラム
├── README.md            # このファイル
├── config/
│   ├── __init__.py
│   └── settings.py      # 設定ファイル（パラメータ調整はここ）
└── modules/
    ├── __init__.py
    ├── sensor.py        # センサー制御
    ├── motor.py         # モーター制御
    └── controller.py    # 走行ロジック（状態管理・PD制御）
```

## 使用方法

```bash
cd rule_based
python main.py
```

Enterキーを押すと走行開始、`Ctrl+C` で停止。

## 走行ロジック

### 状態遷移（優先度順）

1. **緊急停止** - 正面が100mm以下 → 停止
2. **緊急回避** - 側面が80mm以下 → 反対方向へ回避
3. **右コーナー** - 正面が300mm以下 → 右へ曲がる
4. **左コーナー** - 左壁がなくなった → 左へ曲がる
5. **壁沿い走行** - PD制御で左壁との距離を維持
6. **直進** - 誤差が小さい場合 → 速度アップ

### PD制御

```
ステアリング補正 = Kp × 誤差 + Kd × 誤差変化率
```

- **誤差** = 目標距離(200mm) - 左壁との実距離
- 壁に近すぎる → 右へステアリング
- 壁から遠すぎる → 左へステアリング

## パラメータ調整

`config/settings.py` を編集:

### 速度調整
```python
SPEED_SLOW = 0.23    # コーナー時
SPEED_MEDIUM = 0.30  # 通常走行
SPEED_FAST = 0.38    # 直線
```

### PD制御ゲイン
```python
KP = 0.25   # 反応感度（大きい=敏感、小さい=鈍感）
KD = 0.10   # 振動抑制（大きい=安定、小さい=追従性）
```

### 距離閾値
```python
TARGET_WALL_DISTANCE = 200      # 壁との目標距離 (mm)
CORNER_FRONT_DISTANCE = 300     # 正面の壁検出閾値 (mm)
CORNER_NO_WALL_DISTANCE = 500   # 左コーナー検出閾値 (mm)
```

## トラブルシューティング

| 症状 | 対処法 |
|------|--------|
| 蛇行する | `KP` を小さくする / `KD` を大きくする |
| 壁に寄りすぎる | `TARGET_WALL_DISTANCE` を大きくする |
| コーナーで曲がれない | `CORNER_FRONT_DISTANCE` を大きくする |
| 左コーナーを認識しない | `CORNER_NO_WALL_DISTANCE` を小さくする |
| 速度が出ない | `SPEED_*` の値を大きくする |

## センサー配置

```
                    [FrontLeft]   [Center]   [FrontRight]
                         ↖          ↑           ↗
                          \         |          /
[Left] ← ─────────────────────────────────────────────── → [Right]
                          +-----------+
                          |  ミニカー  |
                          +-----------+
```

| インデックス | 名前 | 方向 | 用途 |
|-------------|------|------|------|
| 0 | Left | 真左 | 壁沿い走行のメイン（PD制御） |
| 1 | FrontLeft | 斜め左前 | 左コーナー早期検出・壁接近検出 |
| 2 | Center | 正面 | 前方障害物・右コーナー検出 |
| 3 | FrontRight | 斜め右前 | 右前方障害物検出 |
| 4 | Right | 真右 | 右壁との距離（将来の拡張用） |
